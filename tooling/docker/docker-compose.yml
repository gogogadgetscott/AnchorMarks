services:
  anchormarks:
    build:
      context: ../..
      dockerfile: ./tooling/docker/Dockerfile
      target: production
      args:
        NODE_ENV: ${NODE_ENV:-production}
        PORT: ${PORT:-3000}
        HOST: ${HOST:-0.0.0.0}
        DB_PATH: ${DB_PATH:-./apps/database/anchormarks.db}
        JWT_SECRET: ${JWT_SECRET:-akkAAz6yWmP7kAakpIqJ8iFErDErgyAgtZEyvknv8YI=}
        CORS_ORIGIN: ${CORS_ORIGIN:-https://yourdomain.com}
        SSL_KEY: ${SSL_KEY}
        SSL_CERT: ${SSL_CERT}
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-3000}
      HOST: ${HOST:-0.0.0.0}
      DB_PATH: ${DB_PATH:-./apps/database/anchormarks.db}
      JWT_SECRET: ${JWT_SECRET:-akkAAz6yWmP7kAakpIqJ8iFErDErgyAgtZEyvknv8YI=}
      CORS_ORIGIN: ${CORS_ORIGIN:-https://yourdomain.com}
    container_name: anchormarks
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    volumes:
      - ../../apps/server:/apps/server
      - ../../apps/database:/apps/database
      - ../../apps/ssl:/apps/ssl
      - ../../.env:/apps/.env
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://${HOST:-0.0.0.0}:${PORT:-3000}/api/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  test:
    build:
      context: ../..
      dockerfile: ./tooling/docker/Dockerfile.test
    volumes:
      - ../../apps/server:/apps/server
      - ../../apps/client:/apps/client
      - ../../.env:/apps/.env
    environment:
      NODE_ENV: test
      DB_PATH: ":memory:"
    profiles:
      - test
